<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>demo</title>
</head>

<body>


    <div>
        <input id="js_file" type="file">
        <input id="js_timestamp" type="number" value="0.5">
        <button id="js_button">提取</button>
        <button id="js_info_button">视频信息</button>
    </div>

    <div id="js_info"></div>

    <div id="js_time"></div>


    <div id="js_result"></div>

    <script>
        Module = {
            instantiateWasm(info, receiveInstance) {
                fetch('/wasm/capture.wasm')
                    .then(response => {
                        return response.arrayBuffer()
                    }
                    ).then(bytes => {
                        return WebAssembly.instantiate(bytes, info)
                    }).then(result => {
                        receiveInstance(result.instance);
                    })
            },
            onRuntimeInitialized() {
                console.log('===== wasm 初始化完成 =====');
            }
        }
    </script>

    <script src="/wasm/capture.js"></script>
    <script>
        let timeStampInput = document.querySelector('#js_timestamp');
        let fileInput = document.querySelector('#js_file');
        let timeContainer = document.querySelector('#js_time');
        let durationContainer = document.querySelector('#js_duration');
        let resultContainer = document.querySelector('#js_result');

        function drawImage(width, height, imageBuffer) {
            let canvas = document.createElement('canvas');
            let ctx = canvas.getContext('2d');

            canvas.width = width;
            canvas.height = height;

            let imageData = ctx.createImageData(width, height);
            let j = 0;
            for (let i = 0; i < imageBuffer.length; i++) {
                if (i && i % 3 == 0) {
                    imageData.data[j] = 255;
                    j += 1;
                }

                imageData.data[j] = imageBuffer[i];
                j += 1;
            }

            ctx.putImageData(imageData, 0, 0, 0, 0, width, height);

            resultContainer.appendChild(canvas);
        }

        function readFile(file, callback) {
            let fileReader = new FileReader();

            fileReader.onload = evt => {
                let fileBuffer = new Uint8Array(fileReader.result),
                    fileBufferPtr = Module._malloc(fileBuffer.length * 1.2);

                Module.HEAP8.set(fileBuffer, fileBufferPtr);

                let imgDataPtr = Module._capture(fileBufferPtr, fileBuffer.length, timeStampInput.value * 1000);

                let width = Module.HEAPU32[imgDataPtr / 4],
                    height = Module.HEAPU32[imgDataPtr / 4 + 1],
                    imageBufferPtr = Module.HEAPU32[imgDataPtr / 4 + 2],
                    imageBuffer = Module.HEAPU8.subarray(imageBufferPtr, imageBufferPtr + width * height * 3);

                callback(width, height, imageBuffer);

                Module._free(fileBufferPtr);
                Module._free(imgDataPtr);
                Module._free(imageBufferPtr);
            };

            fileReader.readAsArrayBuffer(file);
        }

        let button = document.querySelector('#js_button');
        button.addEventListener('click', () => {
            let file = fileInput.files[0];
            let startTime = Date.now();

            readFile(file, (width, height, imageBuffer) => {
                resultContainer.innerHTML = '';
                drawImage(width, height, imageBuffer);

                let deltaTime = Date.now() - startTime;

                timeContainer.innerHTML = `<p>累计耗时：${deltaTime}ms</p>`;
            });
        });

        let infoButton = document.querySelector('#js_info_button');
        let infoContainer = document.querySelector('#js_info');
        infoButton.addEventListener('click', () => {
            let file = fileInput.files[0];
            let fileReader = new FileReader();

            fileReader.onload = evt => {
                let fileBuffer = new Uint8Array(fileReader.result),
                    fileBufferPtr = Module._malloc(fileBuffer.length);

                Module.HEAP8.set(fileBuffer, fileBufferPtr);

                let videoInfo = Module._getInfo(fileBufferPtr, fileBuffer.length);

                let width = Module.HEAPU32[videoInfo / 4],
                    height = Module.HEAPU32[videoInfo / 4 + 1],
                    duration = Module.HEAPU32[videoInfo / 4 + 2];

                infoContainer.innerHTML = `<p>宽度：${width}<br>高度：${height}<br>时长：${duration / 1000000}s</p>`;

                Module._free(fileBufferPtr);
                Module._free(videoInfo);
            };

            fileReader.readAsArrayBuffer(file);
        });

    </script>

</body>

</html>